<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR - Oso Bailando</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #ar-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #startButton {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }
        .scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-three.prod.js"></script>
</head>
<body>
    <div id="ar-container">
        <button id="startButton">Iniciar AR</button>
        <div class="loading">Cargando recursos...</div>
        <div class="scan-overlay">Enfoca la imagen target con la cámara</div>
    </div>

    <script>
        let mindarThree = null;
        let mixer = null;
        let model = null;

        document.addEventListener("DOMContentLoaded", async () => {
            const startButton = document.getElementById('startButton');
            const loading = document.querySelector('.loading');
            const scanOverlay = document.querySelector('.scan-overlay');
            
            // Ocultar botón inicialmente
            startButton.style.display = 'none';

            // Inicializar MindAR
            mindarThree = new window.MINDAR.IMAGE.MindARThree({
                container: document.querySelector("#ar-container"),
                imageTargetSrc: "./targets.mind",
                maxTrack: 1,
                uiScanning: true,
                uiLoading: "yes",
            });

            const { renderer, scene, camera } = mindarThree;
            
            // Configurar renderizador
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Cargar modelo 3D
            const loader = new THREE.GLTFLoader();
            loader.load(
                './oso.glb',
                (gltf) => {
                    model = gltf.scene;
                    model.scale.set(0.3, 0.3, 0.3);
                    model.position.set(0, -0.5, 0);
                    model.visible = false;

                    // Configurar animaciones
                    mixer = new THREE.AnimationMixer(model);
                    gltf.animations.forEach((clip) => {
                        mixer.clipAction(clip).play();
                    });

                    // Añadir a la escena
                    const anchor = mindarThree.addAnchor(0);
                    anchor.group.add(model);
                    
                    loading.style.display = 'none';
                    startButton.style.display = 'block';
                },
                undefined,
                (error) => {
                    console.error('Error loading model:', error);
                    loading.textContent = 'Error cargando el modelo';
                }
            );

            // Manejar el botón de inicio
            startButton.addEventListener('click', async () => {
                try {
                    await mindarThree.start();
                    scanOverlay.style.display = 'flex';
                    startButton.style.display = 'none';
                    
                    renderer.setAnimationLoop(() => {
                        if (model) model.visible = mindarThree.isImageTargetTracked(0);
                        if (mixer) mixer.update(clock.getDelta());
                        renderer.render(scene, camera);
                    });
                    
                    // Ocultar overlay después de 3 segundos
                    setTimeout(() => {
                        scanOverlay.style.display = 'none';
                    }, 3000);
                } catch (err) {
                    console.error('Error starting AR:', err);
                    alert('Error al acceder a la cámara');
                }
            });

            // Manejar redimensionado de ventana
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Limpiar al cerrar
            window.addEventListener('beforeunload', () => {
                if (mindarThree) {
                    mindarThree.stop();
                    renderer.setAnimationLoop(null);
                }
            });

            const clock = new THREE.Clock();
        });
    </script>
</body>
</html>

